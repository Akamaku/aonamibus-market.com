<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus-Market | ãƒ—ãƒ­ã®ãŸã‚ã®ãƒã‚¹å£²è²·ãƒãƒ¼ã‚±ãƒƒãƒˆ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ãƒ˜ãƒƒãƒ€ãƒ¼å‘¨ã‚Šã®å¾®èª¿æ•´ */
        #user-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-badge {
            font-weight: bold;
            font-size: 0.9rem;
        }
        .empty-msg {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px;
            color: #888;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <h1 onclick="location.href='index.html'" style="cursor:pointer;">Bus-Market</h1>
        <nav id="user-nav">
            </nav>
    </header>

    <div class="hero">
        <h1>ãƒ—ãƒ­ã®ãŸã‚ã®ãƒã‚¹å£²è²·ãƒãƒ¼ã‚±ãƒƒãƒˆ</h1>
        <p>ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚Œã°èª°ã§ã‚‚è‡ªç”±ã«å‡ºå“ãƒ»å…±æœ‰ãŒå¯èƒ½ã§ã™</p>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="è»Šç¨®ã€ãƒ¡ãƒ¼ã‚«ãƒ¼ã€çŠ¶æ…‹ã‹ã‚‰æ¢ã™...">
            <button onclick="searchVehicles()" class="btn-dark">æ¤œç´¢</button>
        </div>
    </div>

    <main class="container">
        <h2 style="border-left: 5px solid #e60012; padding-left: 15px; margin-bottom: 20px;">æœ€æ–°ã®å‡ºå“è»Šä¸¡</h2>
        <div class="grid" id="vehicle-grid">
            <div class="empty-msg">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </main>

    <script>
        // ã‚ãªãŸã®GASãƒ‡ãƒ—ãƒ­ã‚¤URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxqifQGgA39sQ9SFTzphksRS2VESA2JIKbJ08FSa9O-PCCIxV9E3u2QAVaUCB8m0xx8/exec";

        /**
         * 1. ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«å¿œã˜ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
         */
        function updateHeader() {
            const nav = document.getElementById('user-nav');
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const nickname = localStorage.getItem('userNickname');

            if (isLoggedIn) {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆ
                nav.innerHTML = `
                    <span class="user-badge" style="color:white;">ğŸ‘¤ ${nickname}</span>
                    <button class="nav-btn" onclick="location.href='post.html'">è»Šä¸¡ã‚’å‡ºå“</button>
                    <button class="nav-btn" onclick="location.href='mypage.html'">ãƒã‚¤ãƒšãƒ¼ã‚¸</button>
                    <button class="btn-logout-small" onclick="handleLogout()">è§£é™¤</button>
                `;
            } else {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆ
                nav.innerHTML = `
                    <button class="nav-btn" onclick="location.href='login.html'">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</button>
                `;
            }
        }

        /**
         * 2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è»Šä¸¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
         */
        async function loadVehicles() {
            const grid = document.getElementById('vehicle-grid');

            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();

                // ãƒ‡ãƒ¼ã‚¿ã‚’æœ€æ–°é †ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä¸‹ã®æ–¹ã«ã‚ã‚‹ã‚‚ã®ã»ã©æ–°ã—ã„å‰æï¼‰ã«ä¸¦ã³æ›¿ãˆ
                const sortedData = data.reverse();

                grid.innerHTML = sortedData.length ? '' : '<div class="empty-msg">ç¾åœ¨ã€å‡ºå“ã•ã‚Œã¦ã„ã‚‹è»Šä¸¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';

                sortedData.forEach(v => {
                    // å„é …ç›®ã®åå‰ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ1è¡Œç›®ã®ãƒ˜ãƒƒãƒ€ãƒ¼åã¨ä¸€è‡´ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                    const imgTag = v.image ? `<img src="${v.image}" style="width:100%; height:100%; object-fit:cover;" alt="è»Šä¸¡ç”»åƒ">` : '<div style="padding:40px; color:#ccc;">NO IMAGE</div>';
                    
                    grid.innerHTML += `
                        <div class="card">
                            <div class="card-img">${imgTag}</div>
                            <div class="card-content">
                                <h3 class="card-title">${v.title || 'ç„¡é¡Œã®è»Šä¸¡'}</h3>
                                <p class="card-spec"><b>ãƒ¡ãƒ¼ã‚«ãƒ¼:</b> ${v.manufacturer || '-'} / <b>èµ°è¡Œ:</b> ${v.mileage || '-'}</p>
                                <a href="detail.html?id=${v.id || ''}" class="btn-red-small">è©³ç´°ã‚’è¦‹ã‚‹</a>
                                <div class="card-footer" style="margin-top:10px; font-size:12px; color:#666; display:flex; justify-content:space-between;">
                                    <span>å‡ºå“è€…: ${v.owner || 'åŒ¿å'}</span>
                                </div>
                            </div>
                        </div>`;
                });
            } catch (error) {
                console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                grid.innerHTML = '<div class="empty-msg">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GASã®å…¬é–‹è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
            }
        }

        /**
         * 3. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
         */
        function handleLogout() {
            if (confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆè§£é™¤ï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.clear();
                location.reload();
            }
        }

        /**
         * 4. ç°¡æ˜“æ¤œç´¢æ©Ÿèƒ½ï¼ˆè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’çµã‚Šè¾¼ã‚€ï¼‰
         */
        function searchVehicles() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.getElementsByClassName('card');

            for (let card of cards) {
                const text = card.innerText.toLowerCase();
                card.style.display = text.includes(input) ? "block" : "none";
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        window.onload = () => {
            updateHeader();
            loadVehicles();
        };
    </script>
</body>
</html>
