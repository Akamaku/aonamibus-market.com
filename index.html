<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus-Market | è»Šä¸¡ä¸€è¦§</title>
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; background: #f4f7f8; color: #333; }
        .main-header { background: #e60012; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; }
        .main-header h1 { margin: 0; font-size: 1.5rem; cursor: pointer; }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav-group { display: flex; gap: 10px; align-items: center; }
        button { cursor: pointer; border: none; border-radius: 4px; padding: 8px 15px; font-weight: bold; transition: 0.2s; }
        .btn-post { background: #fff; color: #e60012; }
        .btn-post:hover { background: #eee; }
        .btn-login { background: #333; color: white; }
        .btn-mypage { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        
        /* æ¤œç´¢ãƒãƒ¼ */
        .search-container { margin-bottom: 25px; }
        #search-input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 30px; font-size: 1rem; box-sizing: border-box; outline: none; transition: border-color 0.3s; }
        #search-input:focus { border-color: #e60012; }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        
        /* è»Šä¸¡ã‚«ãƒ¼ãƒ‰ */
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .card-img { width: 100%; height: 200px; background: #eee; position: relative; overflow: hidden; }
        .card-img img { width: 100%; height: 100%; object-fit: cover; }
        .no-image { display: flex; align-items: center; justify-content: center; height: 100%; color: #999; }
        
        .card-content { padding: 15px; }
        .card-title { font-size: 1.25rem; margin: 0 0 10px; color: #000; font-weight: bold; }
        .card-spec { font-size: 0.9rem; color: #555; margin-bottom: 15px; line-height: 1.6; }
        .card-spec span { display: inline-block; background: #f0f0f0; padding: 2px 8px; border-radius: 4px; margin-right: 5px; margin-bottom: 5px; }
        
        .btn-detail { display: block; text-align: center; background: #e60012; color: white; padding: 12px; text-decoration: none; border-radius: 6px; font-weight: bold; }
        .btn-detail:hover { background: #cc0010; }

        .loading, .empty-msg { text-align: center; padding: 50px; font-size: 1.2rem; color: #888; grid-column: 1 / -1; }
    </style>
</head>
<body>

    <header class="main-header">
        <h1 onclick="location.href='index.html'">Bus-Market</h1>
        <nav class="nav-group" id="user-nav">
            </nav>
    </header>

    <main class="container">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼ã€è»Šç¨®ã€å‹å¼ã€å‡ºå“è€…åãªã©ã§æ¤œç´¢...">
        </div>

        <div class="grid" id="vehicle-grid">
            <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        </div>
    </main>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwwUAIiEIWU4YChhZJ5Swow-1CKF0JeHoH4Wl2CiXooQwq2iKiJCxR9BkQZbEP0Mc3w/exec";

        // 1. ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèªã¨ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
        function updateHeader() {
            const nav = document.getElementById('user-nav');
            const nickname = localStorage.getItem('userNickname');
            
            if (nickname) {
                nav.innerHTML = `
                    <button class="btn-mypage" onclick="location.href='mypage.html'">ğŸ‘¤ ${nickname}ã•ã‚“</button>
                    <button class="btn-post" onclick="location.href='post.html'">å‡ºå“ã™ã‚‹</button>
                    <button class="btn-login" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                `;
            } else {
                nav.innerHTML = `
                    <button class="btn-login" onclick="location.href='login.html'">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</button>
                `;
            }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // 2. è»Šä¸¡ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆä¿®æ­£ç‰ˆï¼‰
        async function loadVehicles() {
            const grid = document.getElementById('vehicle-grid');
            try {
                const response = await fetch(GAS_URL);
                const result = await response.json();

                // GASã®æˆ»ã‚Šå€¤ãŒ { vehicles: [...], comments: [...] } ã®å½¢å¼ã§ã‚ã‚‹ã“ã¨ã‚’è€ƒæ…®
                const data = result.vehicles || [];

                if (data.length === 0) {
                    grid.innerHTML = '<div class="empty-msg">ç¾åœ¨ã€å‡ºå“ã•ã‚Œã¦ã„ã‚‹è»Šä¸¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
                    return;
                }

                grid.innerHTML = ""; 

                // é…åˆ—ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦é€†é †ï¼ˆæ–°ç€é †ï¼‰ã«ã™ã‚‹
                [...data].reverse().forEach(v => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    const searchText = `${v.title} ${v.maker} ${v.model} ${v.owner}`.toLowerCase();
                    card.setAttribute('data-search', searchText);

                    card.innerHTML = `
                        <div class="card-img">
                            ${v.image ? `<img src="${v.image}" alt="è»Šä¸¡ç”»åƒ">` : '<div class="no-image">NO IMAGE</div>'}
                        </div>
                        <div class="card-content">
                            <div class="card-title">${v.title || 'ç„¡é¡Œã®è»Šä¸¡'}</div>
                            <div class="card-spec">
                                <span>ãƒ¡ãƒ¼ã‚«ãƒ¼: ${v.maker || '-'}</span>
                                <span>å‹å¼: ${v.model || '-'}</span><br>
                                <span>èµ°è¡Œ: ${v.mileage || '-'}</span>
                                <span>ãƒŸãƒƒã‚·ãƒ§ãƒ³: ${v.mission || '-'}</span><br>
                                <small>å‡ºå“è€…: ${v.owner || 'ã‚²ã‚¹ãƒˆ'}</small>
                            </div>
                            <a href="detail.html?id=${v.id}" class="btn-detail">è©³ç´°ã‚’è¦‹ã‚‹</a>
                        </div>
                    `;
                    grid.appendChild(card);
                });

            } catch (error) {
                console.error("Fetch error:", error);
                grid.innerHTML = '<div class="empty-msg">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
            }
        }

        // 3. æ¤œç´¢æ©Ÿèƒ½
        document.getElementById('search-input').addEventListener('input', function(e) {
            const keyword = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.card');
            
            cards.forEach(card => {
                const content = card.getAttribute('data-search');
                card.style.display = content.includes(keyword) ? 'block' : 'none';
            });
        });

        window.onload = () => {
            updateHeader();
            loadVehicles();
        };
    </script>
</body>

</html>

